# 기능 구현 리스크 점검 보고서

- 작성일: 2026-02-20
- 기준 문서: `README.md`, `claude.md`
- 교차 검토 대상: `core/*`, `ui/*`, `tests/*`
- 범위: 잠재 문제 + 추가 필요 기능 + 테스트 공백 + 우선순위 백로그

## 0) 적용 현황 (2026-02-20)

- `RISK-001` 적용 완료: 자동 새로고침 락 복구 보장 로직 반영
- `RISK-002` 적용 완료: 리네임 후 더 불러오기 키워드 바인딩 수정
- `RISK-003` 적용 완료: 제외어-only 입력 차단
- `RISK-004` 적용 완료: 탭별 페이지네이션 상태 추적 도입
- `RISK-005` 적용 완료: `keyword_groups` 저장 경로 config 일원화 + 레거시 마이그레이션
- `RISK-006` 적용 완료: 2시간 간격으로 코드/문서 정렬
- `RISK-007` 적용 완료: `minimize_to_tray` 실제 최소화 이벤트 연동
- 검증 상태: `python -m pytest -q` 기준 전체 통과

## 1) 점검 요약

- 본 문서는 기능 구현 관점에서 실제 코드와 문서의 불일치, 운영 중 장애 가능성, 테스트 미보장 영역을 정리한 점검 결과다.
- 코드 수정은 포함하지 않으며, 구현 착수 전 의사결정 가능한 수준으로 리스크와 개선안을 명시한다.

## 2) 발견사항 상세

### RISK-001 자동 새로고침 락 플래그 해제 누락 위험

- ID: `RISK-001`
- 심각도: `Critical`
- 우선순위: `P0`
- 증거: `ui/main_window.py:1061`
- 증거: `ui/main_window.py:1076`
- 증거: `ui/main_window.py:1098`
- 증거: `ui/main_window.py:1125`
- 증거: `ui/main_window.py:1190`
- 영향: `_safe_refresh_all()`에서 `_refresh_in_progress=True`로 설정 후 `refresh_all()`이 조기 `return`하면 플래그가 남아 자동 새로고침이 장기 정지될 수 있다.
- 재현 시나리오: API 키가 없는 상태에서 타이머가 `_safe_refresh_all()` 호출.
- 재현 시나리오: `refresh_all()`이 자격증명 검증 실패로 조기 종료.
- 재현 시나리오: 이후 자동 새로고침 타이머가 계속 호출되지만 `_refresh_in_progress` 때문에 스킵.
- 권장 수정: `refresh_all()`이 실제 새로고침을 시작했는지 `bool` 반환 계약을 추가하고, 시작 실패 시 `_safe_refresh_all()`에서 즉시 플래그 해제.
- 권장 수정: 또는 `_safe_refresh_all()`에 `finally` 정리 경로를 두고, `_sequential_refresh_active`가 시작되지 않은 경우만 플래그를 해제.
- 검증 테스트: `tests/test_refresh_lock_recovery.py` 추가.
- 검증 테스트: API 키 미설정 상태에서 `_safe_refresh_all()` 연속 호출 후 `_refresh_in_progress=False`를 보장.

### RISK-002 탭 리네임 후 "더 불러오기"가 옛 키워드를 호출할 가능성

- ID: `RISK-002`
- 심각도: `High`
- 우선순위: `P1`
- 증거: `ui/main_window.py:847`
- 증거: `ui/main_window.py:970`
- 영향: `btn_load` 클릭 시그널이 탭 생성 시점의 `keyword`를 람다 클로저로 고정해 리네임 이후 잘못된 키워드로 API 요청할 수 있다.
- 재현 시나리오: 탭 생성 후 이름 변경.
- 재현 시나리오: 해당 탭에서 `더 불러오기` 실행.
- 재현 시나리오: 새 이름이 아닌 구 이름 기반 fetch 동작 확인.
- 권장 수정: 클릭 시점에 위젯 상태에서 `tab.keyword`를 읽도록 연결 방식 변경.
- 권장 수정: 리네임 시 `btn_load` 시그널을 재바인딩하는 보호 로직 추가.
- 검증 테스트: 리네임 전/후 `btn_load` 호출 시 전달 키워드를 검증하는 회귀 테스트 추가.

### RISK-003 제외어-only 탭 입력 허용으로 조회/표시 경로 불일치

- ID: `RISK-003`
- 심각도: `High`
- 우선순위: `P1`
- 증거: `ui/main_window.py:913`
- 증거: `ui/main_window.py:1240`
- 증거: `core/workers.py:321`
- 영향: `-광고 -코인` 같은 입력이 탭 생성은 되지만 DB 조회 경로에서 빈 키워드로 종료되어 UX가 깨진다.
- 재현 시나리오: 새 탭 추가에서 제외어-only 입력.
- 재현 시나리오: 탭 생성 직후 조회/새로고침 실행.
- 재현 시나리오: 사용자 입장에서는 탭이 존재하나 데이터 경로가 비정상 동작.
- 권장 수정: 탭 추가/리네임/설정 가져오기에서 최소 1개 양(+) 키워드 강제.
- 권장 수정: 기존 데이터 호환을 위해 로드 시점에 제외어-only 탭은 경고 후 정규화 또는 비활성 처리.
- 검증 테스트: 제외어-only 입력 차단 테스트와 레거시 설정 로드 호환 테스트 추가.

### RISK-004 제외어 탭 "더 불러오기" 시작 인덱스 계산 정확도 문제

- ID: `RISK-004`
- 심각도: `High`
- 우선순위: `P1`
- 증거: `ui/main_window.py:1256`
- 증거: `core/workers.py:218`
- 영향: 제외 필터는 API 응답 후 적용되는데 `start_idx`를 저장 건수(`db.get_counts`) 기반으로 계산해 pagination 중복/누락/비효율이 발생할 수 있다.
- 재현 시나리오: 제외어 포함 탭에서 연속 `더 불러오기`.
- 재현 시나리오: API 페이지와 DB 저장 건수 간 불일치 누적.
- 재현 시나리오: 일부 기사 재요청 또는 스킵 발생.
- 권장 수정: 탭별 API 페이지 상태(`last_api_start_index`)를 별도로 추적하고, 저장 건수와 분리된 커서 기반으로 페이지네이션.
- 권장 수정: fetch key별 마지막 start 값을 관리하는 구조체 도입.
- 검증 테스트: 제외어 탭 pagination 시 링크 중복/누락이 없는지 회귀 테스트 추가.

### RISK-005 키워드 그룹 저장/백업 경로 불일치로 데이터 유실 가능성

- ID: `RISK-005`
- 심각도: `Critical`
- 우선순위: `P0`
- 증거: `ui/main_window.py:175`
- 증거: `core/backup.py:74`
- 증거: `ui/main_window.py:1595`
- 증거: `ui/main_window.py:1622`
- 증거: `claude.md:426`
- 영향: 문서/설정 스키마는 `news_scraper_config.json` 기반 그룹 저장을 암시하지만 실제 구현은 `keyword_groups.json` 별도 파일을 사용해 백업/내보내기/복원 범위에서 누락될 수 있다.
- 재현 시나리오: 키워드 그룹 편집 후 설정 내보내기 수행.
- 재현 시나리오: 신규 환경에서 설정 가져오기 또는 백업 복원 수행.
- 재현 시나리오: 탭은 복원되지만 그룹 매핑이 소실.
- 권장 수정: 그룹 데이터를 `news_scraper_config.json`에 통합하거나, 별도 파일 유지 시 백업/내보내기/복원 계약에 명시적으로 포함.
- 권장 수정: 문서(`README.md`, `claude.md`)와 실제 저장 계약을 단일 소스로 통일.
- 검증 테스트: 그룹 생성 후 export/import, backup/restore roundtrip에서 그룹 보존 검증 테스트 추가.

### RISK-006 자동 새로고침 간격 문서-코드 불일치(2시간 vs 3시간)

- ID: `RISK-006`
- 심각도: `Medium`
- 우선순위: `P2`
- 증거: `README.md:13`
- 증거: `claude.md:439`
- 증거: `ui/settings_dialog.py:124`
- 증거: `ui/main_window.py:1937`
- 영향: 사용자 기대치와 실제 간격이 달라 운영 신뢰도와 지원 비용이 증가한다.
- 재현 시나리오: 문서 기준으로 2시간을 기대하고 설정 진입.
- 재현 시나리오: 실제 UI/로직에서 3시간 동작 확인.
- 권장 수정: 제품 의도를 확정 후 코드 또는 문서를 단일 값으로 정렬.
- 권장 수정: 간격 인덱스 표를 문서와 코드에서 동일하게 유지.
- 검증 테스트: 간격 인덱스-분 변환 매핑 단위 테스트 추가.

### RISK-007 `minimize_to_tray` 설정 항목 유휴 상태

- ID: `RISK-007`
- 심각도: `Low`
- 우선순위: `P2`
- 증거: `ui/main_window.py:454`
- 증거: `ui/main_window.py:473`
- 증거: `ui/main_window.py:499`
- 증거: `core/config_store.py:47`
- 영향: 설정은 저장/로드되지만 실제 동작 분기에 사용되지 않아 사용자에게 오해를 준다.
- 재현 시나리오: 설정 파일에서 `minimize_to_tray` 값을 변경.
- 재현 시나리오: 앱 최소화 동작에 영향이 없는지 확인.
- 권장 수정: 실제 최소화 이벤트(`changeEvent` 등) 처리에 연결하거나 설정 항목 제거.
- 권장 수정: UI에 노출되는 옵션명과 실제 동작 분기(`close_to_tray`)를 분리 명확화.
- 검증 테스트: 최소화/닫기 이벤트별 트레이 동작 분기 테스트 추가.

## 3) 추가 필요 기능 제안

- 입력 검증 강화: 탭 추가, 탭 이름 변경, 설정 가져오기에서 최소 1개 양(+) 키워드 강제.
- 새로고침 상태 머신 정리: 조기 종료 경로에서도 `_refresh_in_progress` 일관 해제.
- 탭별 페이지네이션 상태 관리: API `start` 추적 필드 도입.
- 그룹 데이터 일원화: `news_scraper_config.json` 통합 또는 `keyword_groups.json`을 백업/내보내기 대상에 계약화.
- 문서 정합성 정리: `README.md`, `claude.md`, 실제 코드의 간격/스키마/저장 위치 동기화.

## 4) 공용 API/인터페이스/타입 변경 제안

- `refresh_all()` 계약 개선.
- 제안: `def refresh_all(self) -> bool`로 변경해 새로고침 시작 성공 여부를 반환.
- 대안: `_safe_refresh_all()`에서 `finally` 기반 상태 정리 계약 추가.

- 탭 메타 구조 확장.
- 제안: `TabFetchState` 타입(예: `last_api_start_index`, `last_fetch_key`, `last_fetch_ts`) 도입.
- 목적: 저장 건수와 분리된 페이지네이션 제어, 중복/누락 완화.

- 설정 스키마 명시화.
- 제안: `keyword_groups` 저장 위치를 단일 계약으로 고정.
- 후보: `news_scraper_config.json` 내부 필드 통합 또는 별도 파일 표준화 + 백업/내보내기 포함 규칙.

## 5) 테스트 케이스 및 시나리오

### 자동화 리그레션 테스트 제안

- 리네임 후 `btn_load`가 새 키워드로 fetch를 호출하는지 검증.
- API 키 미설정 상태에서 타이머 경유 `_safe_refresh_all()` 반복 호출 시 락 플래그 회복 검증.
- 제외어-only 탭 입력 차단 및 레거시 설정 호환 검증.
- 제외어 탭 pagination 중복/누락 검증.
- 그룹 데이터의 backup/restore 및 export/import roundtrip 보존 검증.

### 수동 QA 체크리스트

- 탭 추가.
- 탭 이름 변경.
- 자동 새로고침 시작/중단/복구.
- 백업 생성 및 재시작 복원.
- 설정 내보내기/가져오기.
- 키워드 그룹 보존 여부 확인.

### 실행 기준

- `python -m pytest -q` 통과.
- 신규 리그레션 테스트 포함 시 전체 테스트 통과.

## 6) 우선순위 백로그 (`P0` / `P1` / `P2`)

### P0

- `RISK-001` 자동 새로고침 락 플래그 회복 보장.
- `RISK-005` 키워드 그룹 데이터 저장/백업 계약 정합화.

### P1

- `RISK-002` 리네임 후 `btn_load` 키워드 바인딩 정합화.
- `RISK-003` 제외어-only 입력 차단 및 호환 처리.
- `RISK-004` 페이지네이션 상태 추적 구조 도입.

### P2

- `RISK-006` 문서-코드 간격 정렬.
- `RISK-007` `minimize_to_tray` 동작 연결 또는 항목 정리.

## 7) 가정 및 기본값

- 파일명은 `implementation_audit.md`로 확정.
- 문서 범위는 "이슈+개선안"으로 확정.
- 본 산출물은 코드 변경이 아닌 점검 문서 작성에 집중한다.
